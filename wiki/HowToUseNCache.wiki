#labels Featured,Phase-QA,Phase-Deploy
= How to use ncache =




  * install the ncache
{{{
    ./configure

    make 

    make install
}}}

    run the "mkdir_ngx_cache.sh" to make cache dir:
    {{{
      {install_prefix}/bin/mkdir_ngx_cache.sh {install_prefix}/conf/ncache.conf
    }}}

    * example to make cache directories  :
    {{{
      /usr/local/ncache/bin/mkdir_ngx_cache.sh /usr/local/ncache/conf/ncache.conf
    }}}

    note:only support linux

  * example to config the ncache
    
  {{{

  user  www www;

  worker_processes 4;

  events
  {
    worker_connections  10240;
  }


  http
  {
    sendfile        on;

    keepalive_timeout  65;

    #here to set the storage max size 2 Power 25 about 30,000,000
    cache_max_size 25;


    upstream backend
    {
      server 10.1.1.1;
      server 10.1.1.2;

      cachedir /data0/ 128 128;
      cachedir /data1/ 64 64;
    }


    server
    {
      listen       80;

      set $purge_uri $request_uri;

      location /
      {
        if ($request_method ~ "PURGE")
        {
          rewrite (.*) /PURGE$1 last;
        }                                                                                         
        proxy_pass http://backend;
        
        #here you can ignore any client use "Cache-Control:no-cache" headers refresh the cache

        proxy_ignore_client_no_cache on;
      }                
      
      #allow some one who can use http PURGE method delete the caches
      location /PURGE/ 
      {   
        internal;        
        allow   10.1.1.0/24;           
        deny    all;
        purge;  
      }
      
      #use "http://{serverip}/status_infos" watch nginx services status
      location /status_infos
      {
        access_log      off;
        stub_status     on;
      }     
    }  
  }

  }}}

  * backend set

    you must add the http header "Cache-Control: max-age=***" to the backend server which you want to be cached, ortherwise, ncache will not cache it forever.

    if you set max-age < 1 minute ncache will set it to 1 minute, and ncache will exact all max-age to minute, so please align it to 60.


  * run and kill

    run: {install_prefix}/sbin/ncache

    kill: kill -9 `ps auwx|grep ncache|awk '{print $2}'` 